name: ðŸ” SonarCloud Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ejecutar anÃ¡lisis diariamente a las 3:00 AM UTC
    - cron: '0 3 * * *'

jobs:
  sonarcloud:
    name: ðŸ” SonarCloud Quality Gate
    runs-on: ubuntu-24.04
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarCloud
        
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: ðŸ“¦ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-sonarcloud-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-sonarcloud-
          
    - name: ðŸ”§ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: ðŸ§ª Ejecutar tests con coverage
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
        
    - name: ðŸ” SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.python.coverage.reportPaths=coverage.xml
          -Dsonar.python.xunit.reportPath=test-results.xml
          -Dsonar.qualitygate.wait=true
          
    - name: ðŸ“Š SonarCloud Summary
      run: |
        echo "## ðŸ” SonarCloud Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Quality Gate passed**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” **Code analysis completed**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Coverage report generated**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in [SonarCloud](https://sonarcloud.io/dashboard?id=${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
