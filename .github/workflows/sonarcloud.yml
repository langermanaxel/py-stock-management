name: 🔍 SonarCloud Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ejecutar análisis diariamente a las 3:00 AM UTC
    - cron: '0 3 * * *'

jobs:
  sonarcloud:
    name: 🔍 SonarCloud Quality Gate
    runs-on: ubuntu-24.04
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarCloud
        
    - name: 🐍 Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: 📦 Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-sonarcloud-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-sonarcloud-
          
    - name: 🔧 Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: 🧪 Ejecutar tests con coverage
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
        
    - name: 🔍 SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.python.coverage.reportPaths=coverage.xml
          -Dsonar.python.xunit.reportPath=test-results.xml
          -Dsonar.qualitygate.wait=true
          
    - name: 📊 SonarCloud Summary
      run: |
        echo "## 🔍 SonarCloud Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Quality Gate passed**" >> $GITHUB_STEP_SUMMARY
        echo "🔍 **Code analysis completed**" >> $GITHUB_STEP_SUMMARY
        echo "📊 **Coverage report generated**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in [SonarCloud](https://sonarcloud.io/dashboard?id=${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
