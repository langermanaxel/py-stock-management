<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Inventario</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Alpine.js CDN -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <!-- Sistema de Notificaciones Toast -->
    <div id="toast-container" 
         x-data="toastManager()" 
         x-show="toasts.length > 0"
         class="toast-container">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible" 
                 x-transition:enter="toast-enter"
                 x-transition:enter-start="toast-enter-start"
                 x-transition:enter-end="toast-enter-end"
                 x-transition:leave="toast-leave"
                 x-transition:leave-start="toast-leave-start"
                 x-transition:leave-end="toast-leave-end"
                 :class="`toast toast-${toast.type}`"
                 @click="removeToast(toast.id)">
                <div class="toast-icon">
                    <i :class="getToastIcon(toast.type)"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title" x-text="toast.title"></div>
                    <div class="toast-message" x-text="toast.message"></div>
                </div>
                <button class="toast-close" @click="removeToast(toast.id)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1><i class="fas fa-boxes"></i> Sistema de Gestión de Inventario</h1>
            </div>
            
            <!-- Información del Usuario -->
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-details">
                    <span class="user-name" id="userName"></span>
                    <span class="user-role" id="userRole"></span>
                </div>
                <div class="user-actions">
                    <a href="#" class="user-btn" title="Mi Perfil" onclick="showProfile()">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <a href="#" class="user-btn logout-btn" title="Cerrar Sesión" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
            
            <nav class="nav">
                <button class="nav-toggle" onclick="toggleNav()">
                    <i class="fas fa-bars"></i>
                </button>
                <ul class="nav-menu">
                    <li><a href="#" onclick="showTab('dashboard')" class="nav-link active">Dashboard</a></li>
                    <li><a href="#" onclick="showTab('categories')" class="nav-link" data-role="user">Categorías</a></li>
                    <li><a href="#" onclick="showTab('products')" class="nav-link" data-role="user">Productos</a></li>
                    <li><a href="#" onclick="showTab('stock')" class="nav-link" data-role="user">Stock</a></li>
                    <li><a href="#" onclick="showTab('orders')" class="nav-link" data-role="user">Órdenes</a></li>
                    <li><a href="#" onclick="showTab('purchases')" class="nav-link" data-role="user">Compras</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Productos</h3>
                        <p id="totalProducts">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Stock Bajo</h3>
                        <p id="lowStockCount">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Órdenes Pendientes</h3>
                        <p id="pendingOrders">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Órdenes de Compra</h3>
                        <p id="pendingPurchases">0</p>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <h2><i class="fas fa-tags"></i> Categorías</h2>
                <div class="form-section" data-role="manager">
                    <h3>Agregar Categoría</h3>
                    <form id="categoryForm" x-data="formValidator()" @submit.prevent="submitCategory">
                        <div class="form-group">
                            <label for="categoryName">Nombre:</label>
                            <input type="text" 
                                   id="categoryName" 
                                   name="name" 
                                   required 
                                   minlength="2" 
                                   maxlength="50"
                                   x-model="formData.name"
                                   @blur="validateField('name')"
                                   :class="{'error': errors.name, 'success': !errors.name && formData.name}">
                            <div class="error-message" x-show="errors.name" x-text="errors.name"></div>
                        </div>
                        <div class="form-group">
                            <label for="categoryDescription">Descripción:</label>
                            <textarea id="categoryDescription" 
                                      name="description" 
                                      maxlength="200"
                                      x-model="formData.description"
                                      @blur="validateField('description')"
                                      :class="{'error': errors.description, 'success': !errors.description && formData.description}"></textarea>
                            <div class="error-message" x-show="errors.description" x-text="errors.description"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Categoría</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Categorías Existentes</h3>
                    <div id="categoriesList"></div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <h2><i class="fas fa-box"></i> Productos</h2>
                <div class="form-section" data-role="manager">
                    <h3>Agregar Producto</h3>
                    <form id="productForm" x-data="formValidator()" @submit.prevent="submitProduct">
                        <div class="form-group">
                            <label for="productName">Nombre:</label>
                            <input type="text" 
                                   id="productName" 
                                   name="name" 
                                   required 
                                   minlength="2" 
                                   maxlength="100"
                                   x-model="formData.name"
                                   @blur="validateField('name')"
                                   :class="{'error': errors.name, 'success': !errors.name && formData.name}">
                            <div class="error-message" x-show="errors.name" x-text="errors.name"></div>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Descripción:</label>
                            <textarea id="productDescription" 
                                      name="description" 
                                      maxlength="500"
                                      x-model="formData.description"
                                      @blur="validateField('description')"
                                      :class="{'error': errors.description, 'success': !errors.description && formData.description}"></textarea>
                            <div class="error-message" x-show="errors.description" x-text="errors.description"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice">Precio:</label>
                                <input type="number" 
                                       id="productPrice" 
                                       name="price" 
                                       required 
                                       min="0" 
                                       step="0.01"
                                       x-model="formData.price"
                                       @blur="validateField('price')"
                                       :class="{'error': errors.price, 'success': !errors.price && formData.price}">
                                <div class="error-message" x-show="errors.price" x-text="errors.price"></div>
                            </div>
                            <div class="form-group">
                                <label for="productCategory">Categoría:</label>
                                <select id="productCategory" 
                                        name="category_id" 
                                        required
                                        x-model="formData.category_id"
                                        @blur="validateField('category_id')"
                                        :class="{'error': errors.category_id, 'success': !errors.category_id && formData.category_id}">
                                    <option value="">Seleccionar categoría</option>
                                </select>
                                <div class="error-message" x-show="errors.category_id" x-text="errors.category_id"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Producto</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Productos Existentes</h3>
                    <div class="search-filter">
                        <input type="text" id="productSearch" placeholder="Buscar productos..." class="search-input">
                        <select id="categoryFilter" class="filter-select">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <div id="productsList"></div>
                </div>
            </div>

            <!-- Stock Tab -->
            <div id="stock" class="tab-content">
                <h2><i class="fas fa-warehouse"></i> Stock</h2>
                <div class="form-section" data-role="manager">
                    <h3>Agregar Stock</h3>
                    <form id="stockForm" x-data="formValidator()" @submit.prevent="submitStock">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="stockProduct">Producto:</label>
                                <select id="stockProduct" 
                                        name="product_id" 
                                        required
                                        x-model="formData.product_id"
                                        @blur="validateField('product_id')"
                                        :class="{'error': errors.product_id, 'success': !errors.product_id && formData.product_id}">
                                    <option value="">Seleccionar producto</option>
                                </select>
                                <div class="error-message" x-show="errors.product_id" x-text="errors.product_id"></div>
                            </div>
                            <div class="form-group">
                                <label for="stockQuantity">Cantidad:</label>
                                <input type="number" 
                                       id="stockQuantity" 
                                       name="quantity" 
                                       required 
                                       min="0"
                                       x-model="formData.quantity"
                                       @blur="validateField('quantity')"
                                       :class="{'error': errors.quantity, 'success': !errors.quantity && formData.quantity}">
                                <div class="error-message" x-show="errors.quantity" x-text="errors.quantity"></div>
                            </div>
                            <div class="form-group">
                                <label for="stockMin">Stock Mínimo:</label>
                                <input type="number" 
                                       id="stockMin" 
                                       name="min_stock" 
                                       min="0"
                                       x-model="formData.min_stock"
                                       @blur="validateField('min_stock')"
                                       :class="{'error': errors.min_stock, 'success': !errors.min_stock && formData.min_stock}">
                                <div class="error-message" x-show="errors.min_stock" x-text="errors.min_stock"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Stock</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Stock Actual</h3>
                    <div id="stockList"></div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <h2><i class="fas fa-shopping-cart"></i> Órdenes</h2>
                <div class="form-section">
                    <h3>Crear Orden de Compra</h3>
                    <form id="purchaseOrderForm" x-data="formValidator()" @submit.prevent="submitPurchaseOrder">
                        <div class="form-group">
                            <label for="supplierName">Nombre del Proveedor:</label>
                            <input type="text" 
                                   id="supplierName" 
                                   name="supplier_name" 
                                   required 
                                   minlength="2" 
                                   maxlength="200"
                                   x-model="formData.supplier_name"
                                   @blur="validateField('supplier_name')"
                                   :class="{'error': errors.supplier_name, 'success': !errors.supplier_name && formData.supplier_name}">
                            <div class="error-message" x-show="errors.supplier_name" x-text="errors.supplier_name"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Productos:</label>
                            <div class="product-selection">
                                <div class="form-row">
                                    <select id="productSelect" class="form-control">
                                        <option value="">Seleccionar producto</option>
                                    </select>
                                    <input type="number" id="quantityInput" placeholder="Cantidad" min="1" class="form-control">
                                    <input type="number" id="unitPriceInput" placeholder="Precio unitario" min="0" step="0.01" class="form-control">
                                    <button type="button" onclick="addPurchaseItem()" class="btn btn-secondary">Agregar</button>
                                </div>
                            </div>
                            <div id="purchaseItems" class="purchase-items"></div>
                        </div>
                        
                        <button type="submit" id="createOrderBtn" class="btn btn-primary" disabled>Crear Orden de Compra</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Órdenes Pendientes</h3>
                    <div id="ordersList"></div>
                </div>
            </div>

            <!-- Purchases Tab -->
            <div id="purchases" class="tab-content">
                <h2><i class="fas fa-truck"></i> Compras</h2>
                <div class="list-section">
                    <h3>Órdenes de Compra Completadas</h3>
                    <div id="purchasesList"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Incluir configuración y sistema de autenticación JWT -->
    <!-- 1. Configuración (debe cargarse primero) -->
    <script defer src="{{ url_for('static', filename='js/config.js') }}"></script>
    
    <!-- 2. Sistema de autenticación JWT -->
    <script defer src="{{ url_for('static', filename='js/auth.js') }}"></script>
    
    <!-- 3. Helper HTTP -->
    <script defer src="{{ url_for('static', filename='js/http-helper.js') }}"></script>
    
    <!-- 4. Helpers de Alpine.js -->
    <script defer src="{{ url_for('static', filename='js/alpine-helpers.js') }}"></script>
    
    <!-- 5. Utilidades de página y guardias -->
    <script defer src="{{ url_for('static', filename='js/page-utils.js') }}"></script>
    
    <!-- 6. Aplicación principal (debe cargarse último) -->
    <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <script>
        // Inicialización segura con guardias por página
        document.addEventListener('DOMContentLoaded', async function() {
            // Crear instancia del guardia del DOM
            const guard = new DOMGuard();
            
            // Solo ejecutar en el dashboard
            guard.executeOnDashboard(async () => {
                try {
                    // Verificar si el usuario está autenticado
                    if (!authManager.isAuthenticated()) {
                        window.location.href = '/login';
                        return;
                    }
                    
                    // Inicializar el manager de autenticación
                    await authManager.initialize();
                    
                    // Mostrar información del usuario
                    updateUserInfo();
                    
                    // Actualizar UI según el rol del usuario
                    updateUIForUserRole();
                    
                    // Cargar datos iniciales
                    loadDashboard();
                } catch (error) {
                    console.error('Error inicializando dashboard:', error);
                }
            });
        });
        
        // Función para mostrar información del usuario (solo en dashboard)
        function updateUserInfo() {
            const guard = new DOMGuard();
            guard.safeExecute('#userName', (userNameElement) => {
                const user = authManager.getUser();
                if (user && userNameElement) {
                    userNameElement.textContent = `${user.first_name} ${user.last_name}`;
                    
                    // Actualizar rol del usuario
                    guard.safeExecute('#userRole', (userRoleElement) => {
                        if (userRoleElement) {
                            userRoleElement.textContent = user.role;
                        }
                    });
                    
                    // Mostrar información del usuario
                    guard.safeExecute('#userInfo', (userInfoElement) => {
                        if (userInfoElement) {
                            userInfoElement.style.display = 'flex';
                        }
                    });
                }
            });
        }
        
        // Función para mostrar perfil (solo en dashboard)
        function showProfile() {
            const guard = new DOMGuard();
            guard.executeOnDashboard(() => {
                showToast('info', 'Perfil', 'Función de perfil en desarrollo');
            });
        }
        
        // Función para logout (solo en dashboard)
        function logout() {
            const guard = new DOMGuard();
            guard.executeOnDashboard(() => {
                authManager.logout();
            });
        }
    </script>
</body>
</html> 